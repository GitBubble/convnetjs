var convnetjs=convnetjs||{REVISION:"ALPHA"};
(function(f){var g=!1,c=0,b=function(){if(g)return g=!1,c;var e=2*Math.random()-1,a=2*Math.random()-1,d=e*e+a*a;if(0==d||1<d)return b();d=Math.sqrt(-2*Math.log(d)/d);c=a*d;g=!0;return e*d},a=function(e,a){return Math.random()*(a-e)+e},d=function(e,a){for(var d=0,b=e.length;d<b;d++)if(e[d]===a)return!0;return!1};f.randf=a;f.randi=function(e,a){return Math.floor(Math.random()*(a-e)+e)};f.randn=function(e,a){return e+b()*a};f.zeros=function(e){if("undefined"===typeof e||isNaN(e))return[];if("undefined"===
typeof ArrayBuffer){for(var a=Array(e),d=0;d<e;d++)a[d]=0;return a}return new Float64Array(e)};f.maxmin=function(e){if(0===e.length)return{};for(var a=e[0],d=e[0],b=0,c=0,f=e.length,p=1;p<f;p++)e[p]>a&&(a=e[p],b=p),e[p]<d&&(d=e[p],c=p);return{maxi:b,maxv:a,mini:c,minv:d,dv:a-d}};f.randperm=function(e){var a=e,d,b=[];for(d=0;d<e;d++)b[d]=d;for(;a--;)e=Math.floor(Math.random()*(a+1)),d=b[a],b[a]=b[e],b[e]=d;return b};f.weightedSample=function(e,d){for(var b=a(0,1),c=0,v=0,f=e.length;v<f;v++)if(c+=d[v],
b<c)return e[v]};f.arrUnique=function(e){for(var a=[],b=0,c=e.length;b<c;b++)d(a,e[b])||a.push(e[b]);return a};f.arrContains=d;f.getopt=function(e,a,d){if("string"===typeof a)return"undefined"!==typeof e[a]?e[a]:d;for(var b=0;b<a.length;b++){var c=a[b];"undefined"!==typeof e[c]&&(d=e[c])}return d};f.assert=function(e,a){if(!e){a=a||"Assertion failed";if("undefined"!==typeof Error)throw Error(a);throw a;}}})(convnetjs);
(function(f){var g=function(c,b,a,d){if("[object Array]"===Object.prototype.toString.call(c))for(this.sy=this.sx=1,this.depth=c.length,this.w=f.zeros(this.depth),this.dw=f.zeros(this.depth),b=0;b<this.depth;b++)this.w[b]=c[b];else{this.sx=c;this.sy=b;this.depth=a;var e=c*b*a;this.w=f.zeros(e);this.dw=f.zeros(e);if("undefined"===typeof d)for(c=Math.sqrt(1/(c*b*a)),b=0;b<e;b++)this.w[b]=f.randn(0,c);else for(b=0;b<e;b++)this.w[b]=d}};g.prototype={get:function(c,b,a){return this.w[(this.sx*b+c)*this.depth+
a]},set:function(c,b,a,d){this.w[(this.sx*b+c)*this.depth+a]=d},add:function(c,b,a,d){this.w[(this.sx*b+c)*this.depth+a]+=d},get_grad:function(c,b,a){return this.dw[(this.sx*b+c)*this.depth+a]},set_grad:function(c,b,a,d){this.dw[(this.sx*b+c)*this.depth+a]=d},add_grad:function(c,b,a,d){this.dw[(this.sx*b+c)*this.depth+a]+=d},cloneAndZero:function(){return new g(this.sx,this.sy,this.depth,0)},clone:function(){for(var c=new g(this.sx,this.sy,this.depth,0),b=this.w.length,a=0;a<b;a++)c.w[a]=this.w[a];
return c},addFrom:function(c){for(var b=0;b<this.w.length;b++)this.w[b]+=c.w[b]},addFromScaled:function(c,b){for(var a=0;a<this.w.length;a++)this.w[a]+=b*c.w[a]},setConst:function(c){for(var b=0;b<this.w.length;b++)this.w[b]=c},toJSON:function(){var c={};c.sx=this.sx;c.sy=this.sy;c.depth=this.depth;c.w=this.w;return c},fromJSON:function(c){this.sx=c.sx;this.sy=c.sy;this.depth=c.depth;var b=this.sx*this.sy*this.depth;this.w=f.zeros(b);this.dw=f.zeros(b);for(var a=0;a<b;a++)this.w[a]=c.w[a]}};f.Vol=
g})(convnetjs);
(function(f){var g=f.Vol;f.augment=function(c,b,a,d,e){"undefined"===typeof e&&(e=!1);"undefined"===typeof a&&(a=f.randi(0,c.sx-b));"undefined"===typeof d&&(d=f.randi(0,c.sy-b));var v;if(b!==c.sx||0!==a||0!==d){v=new g(b,b,c.depth,0);for(var m=0;m<b;m++)for(var l=0;l<b;l++)if(!(0>m+a||m+a>=c.sx||0>l+d||l+d>=c.sy))for(var h=0;h<c.depth;h++)v.set(m,l,h,c.get(m+a,l+d,h))}else v=c;if(e){c=v.cloneAndZero();for(m=0;m<v.sx;m++)for(l=0;l<v.sy;l++)for(h=0;h<v.depth;h++)c.set(m,l,h,v.get(v.sx-m-1,l,h));v=c}return v};
f.img_to_vol=function(c,b){"undefined"===typeof b&&(b=!1);var a=document.createElement("canvas");a.width=c.width;a.height=c.height;var d=a.getContext("2d");try{d.drawImage(c,0,0)}catch(m){if("NS_ERROR_NOT_AVAILABLE"===m.name)return!1;throw m;}try{var e=d.getImageData(0,0,a.width,a.height)}catch(m){if("IndexSizeError"===m.name)return!1;throw m;}e=e.data;a=c.width;c=c.height;for(var f=[],d=0;d<e.length;d++)f.push(e[d]/255-.5);e=new g(a,c,4,0);e.w=f;if(b){b=new g(a,c,1,0);for(d=0;d<a;d++)for(f=0;f<c;f++)b.set(d,
f,0,e.get(d,f,0));e=b}return e}})(convnetjs);
(function(f){var g=f.Vol,c=function(a){a=a||{};this.out_depth=a.filters;this.sx=a.sx;this.in_depth=a.in_depth;this.in_sx=a.in_sx;this.in_sy=a.in_sy;this.sy="undefined"!==typeof a.sy?a.sy:this.sx;this.stride="undefined"!==typeof a.stride?a.stride:1;this.pad="undefined"!==typeof a.pad?a.pad:0;this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:0;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.out_sx=Math.floor((this.in_sx+2*this.pad-this.sx)/this.stride+
1);this.out_sy=Math.floor((this.in_sy+2*this.pad-this.sy)/this.stride+1);this.layer_type="conv";a="undefined"!==typeof a.bias_pref?a.bias_pref:0;this.filters=[];for(var d=0;d<this.out_depth;d++)this.filters.push(new g(this.sx,this.sy,this.in_depth));this.biases=new g(1,1,this.out_depth,a)};c.prototype={forward:function(a,d){this.in_act=a;d=new g(this.out_sx|0,this.out_sy|0,this.out_depth|0,0);for(var e=a.sx|0,b=a.sy|0,c=this.stride|0,l=0;l<this.out_depth;l++)for(var f=this.filters[l],q,p=-this.pad|
0,u=0;u<this.out_sy;p+=c,u++){q=-this.pad|0;for(var k=0;k<this.out_sx;q+=c,k++){for(var r=0,n=0;n<f.sy;n++)for(var w=p+n,t=0;t<f.sx;t++){var x=q+t;if(0<=w&&w<b&&0<=x&&x<e)for(var y=0;y<f.depth;y++)r+=f.w[(f.sx*n+t)*f.depth+y]*a.w[(e*w+x)*a.depth+y]}r+=this.biases.w[l];d.set(k,u,l,r)}}return this.out_act=d},backward:function(){var a=this.in_act;a.dw=f.zeros(a.w.length);for(var d=a.sx|0,e=a.sy|0,b=this.stride|0,c=0;c<this.out_depth;c++)for(var l=this.filters[c],h,q=-this.pad|0,p=0;p<this.out_sy;q+=
b,p++){h=-this.pad|0;for(var u=0;u<this.out_sx;h+=b,u++){for(var k=this.out_act.get_grad(u,p,c),r=0;r<l.sy;r++)for(var n=q+r,g=0;g<l.sx;g++){var t=h+g;if(0<=n&&n<e&&0<=t&&t<d)for(var x=0;x<l.depth;x++){var y=(d*n+t)*a.depth+x,z=(l.sx*r+g)*l.depth+x;l.dw[z]+=a.w[y]*k;a.dw[y]+=l.w[z]*k}}this.biases.dw[c]+=k}}},getParamsAndGrads:function(){for(var a=[],d=0;d<this.out_depth;d++)a.push({params:this.filters[d].w,grads:this.filters[d].dw,l2_decay_mul:this.l2_decay_mul,l1_decay_mul:this.l1_decay_mul});a.push({params:this.biases.w,
grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0});return a},toJSON:function(){var a={};a.sx=this.sx;a.sy=this.sy;a.stride=this.stride;a.in_depth=this.in_depth;a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.l1_decay_mul=this.l1_decay_mul;a.l2_decay_mul=this.l2_decay_mul;a.pad=this.pad;a.filters=[];for(var d=0;d<this.filters.length;d++)a.filters.push(this.filters[d].toJSON());a.biases=this.biases.toJSON();return a},fromJSON:function(a){this.out_depth=
a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.sx=a.sx;this.sy=a.sy;this.stride=a.stride;this.in_depth=a.in_depth;this.filters=[];this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:1;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.pad="undefined"!==typeof a.pad?a.pad:0;for(var d=0;d<a.filters.length;d++){var e=new g(0,0,0,0);e.fromJSON(a.filters[d]);this.filters.push(e)}this.biases=new g(0,0,0,0);this.biases.fromJSON(a.biases)}};
var b=function(a){a=a||{};this.out_depth="undefined"!==typeof a.num_neurons?a.num_neurons:a.filters;this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:0;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="fc";a="undefined"!==typeof a.bias_pref?a.bias_pref:0;this.filters=[];for(var d=0;d<this.out_depth;d++)this.filters.push(new g(1,1,this.num_inputs));this.biases=new g(1,1,this.out_depth,
a)};b.prototype={forward:function(a,d){this.in_act=a;d=new g(1,1,this.out_depth,0);a=a.w;for(var e=0;e<this.out_depth;e++){for(var b=0,c=this.filters[e].w,f=0;f<this.num_inputs;f++)b+=a[f]*c[f];b+=this.biases.w[e];d.w[e]=b}return this.out_act=d},backward:function(){var a=this.in_act;a.dw=f.zeros(a.w.length);for(var d=0;d<this.out_depth;d++){for(var e=this.filters[d],b=this.out_act.dw[d],c=0;c<this.num_inputs;c++)a.dw[c]+=e.w[c]*b,e.dw[c]+=a.w[c]*b;this.biases.dw[d]+=b}},getParamsAndGrads:function(){for(var a=
[],d=0;d<this.out_depth;d++)a.push({params:this.filters[d].w,grads:this.filters[d].dw,l1_decay_mul:this.l1_decay_mul,l2_decay_mul:this.l2_decay_mul});a.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0});return a},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;a.l1_decay_mul=this.l1_decay_mul;a.l2_decay_mul=this.l2_decay_mul;a.filters=[];for(var d=0;d<this.filters.length;d++)a.filters.push(this.filters[d].toJSON());
a.biases=this.biases.toJSON();return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.num_inputs=a.num_inputs;this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:1;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.filters=[];for(var d=0;d<a.filters.length;d++){var e=new g(0,0,0,0);e.fromJSON(a.filters[d]);this.filters.push(e)}this.biases=new g(0,0,0,0);this.biases.fromJSON(a.biases)}};
f.ConvLayer=c;f.FullyConnLayer=b})(convnetjs);
(function(f){var g=f.Vol,c=function(b){b=b||{};this.sx=b.sx;this.in_depth=b.in_depth;this.in_sx=b.in_sx;this.in_sy=b.in_sy;this.sy="undefined"!==typeof b.sy?b.sy:this.sx;this.stride="undefined"!==typeof b.stride?b.stride:2;this.pad="undefined"!==typeof b.pad?b.pad:0;this.out_depth=this.in_depth;this.out_sx=Math.floor((this.in_sx+2*this.pad-this.sx)/this.stride+1);this.out_sy=Math.floor((this.in_sy+2*this.pad-this.sy)/this.stride+1);this.layer_type="pool";this.switchx=f.zeros(this.out_sx*this.out_sy*
this.out_depth);this.switchy=f.zeros(this.out_sx*this.out_sy*this.out_depth)};c.prototype={forward:function(b,a){this.in_act=b;a=new g(this.out_sx,this.out_sy,this.out_depth,0);for(var d=0,e=0;e<this.out_depth;e++)for(var c=-this.pad,f,l=0;l<this.out_sx;c+=this.stride,l++){f=-this.pad;for(var h=0;h<this.out_sy;f+=this.stride,h++){for(var q=-99999,p=-1,u=-1,k=0;k<this.sx;k++)for(var r=0;r<this.sy;r++){var n=f+r,w=c+k;if(0<=n&&n<b.sy&&0<=w&&w<b.sx){var t=b.get(w,n,e);t>q&&(q=t,p=w,u=n)}}this.switchx[d]=
p;this.switchy[d]=u;d++;a.set(l,h,e,q)}}return this.out_act=a},backward:function(){var b=this.in_act;b.dw=f.zeros(b.w.length);for(var a=0,d=0;d<this.out_depth;d++)for(var e=0;e<this.out_sx;e++)for(var c=0;c<this.out_sy;c++){var m=this.out_act.get_grad(e,c,d);b.add_grad(this.switchx[a],this.switchy[a],d,m);a++}},getParamsAndGrads:function(){return[]},toJSON:function(){var b={};b.sx=this.sx;b.sy=this.sy;b.stride=this.stride;b.in_depth=this.in_depth;b.out_depth=this.out_depth;b.out_sx=this.out_sx;b.out_sy=
this.out_sy;b.layer_type=this.layer_type;b.pad=this.pad;return b},fromJSON:function(b){this.out_depth=b.out_depth;this.out_sx=b.out_sx;this.out_sy=b.out_sy;this.layer_type=b.layer_type;this.sx=b.sx;this.sy=b.sy;this.stride=b.stride;this.in_depth=b.in_depth;this.pad="undefined"!==typeof b.pad?b.pad:0;this.switchx=f.zeros(this.out_sx*this.out_sy*this.out_depth);this.switchy=f.zeros(this.out_sx*this.out_sy*this.out_depth)}};f.PoolLayer=c})(convnetjs);
(function(f){var g=f.getopt,c=function(b){b=b||{};this.out_depth=g(b,["out_depth","depth"],0);this.out_sx=g(b,["out_sx","sx","width"],1);this.out_sy=g(b,["out_sy","sy","height"],1);this.layer_type="input"};c.prototype={forward:function(b,a){return this.out_act=this.in_act=b},backward:function(){},getParamsAndGrads:function(){return[]},toJSON:function(){var b={};b.out_depth=this.out_depth;b.out_sx=this.out_sx;b.out_sy=this.out_sy;b.layer_type=this.layer_type;return b},fromJSON:function(b){this.out_depth=
b.out_depth;this.out_sx=b.out_sx;this.out_sy=b.out_sy;this.layer_type=b.layer_type}};f.InputLayer=c})(convnetjs);
(function(f){var g=f.Vol,c=function(a){a=a||{};this.out_depth=this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="softmax"};c.prototype={forward:function(a,e){this.in_act=a;e=new g(1,1,this.out_depth,0);var b=a.w;a=a.w[0];for(var d=1;d<this.out_depth;d++)b[d]>a&&(a=b[d]);for(var c=f.zeros(this.out_depth),h=0,d=0;d<this.out_depth;d++){var q=Math.exp(b[d]-a),h=h+q;c[d]=q}for(d=0;d<this.out_depth;d++)c[d]/=h,e.w[d]=c[d];this.es=c;return this.out_act=e},backward:function(a){var e=
this.in_act;e.dw=f.zeros(e.w.length);for(var d=0;d<this.out_depth;d++)e.dw[d]=-((d===a?1:0)-this.es[d]);return-Math.log(this.es[a])},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.num_inputs=a.num_inputs}};var b=function(a){a=
a||{};this.out_depth=this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="regression"};b.prototype={forward:function(a,e){return this.out_act=this.in_act=a},backward:function(a){var e=this.in_act;e.dw=f.zeros(e.w.length);var b=0;if(a instanceof Array||a instanceof Float64Array)for(var d=0;d<this.out_depth;d++){var c=e.w[d]-a[d];e.dw[d]=c;b+=.5*c*c}else"number"===typeof a?(c=e.w[0]-a,e.dw[0]=c):(d=a.dim,c=e.w[d]-a.val,e.dw[d]=c),b+=.5*c*c;return b},getParamsAndGrads:function(){return[]},
toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.num_inputs=a.num_inputs}};var a=function(a){a=a||{};this.out_depth=this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="svm"};a.prototype={forward:function(a,e){return this.out_act=
this.in_act=a},backward:function(a){var e=this.in_act;e.dw=f.zeros(e.w.length);for(var b=e.w[a],d=0,c=0;c<this.out_depth;c++)if(a!==c){var h=-b+e.w[c]+1;0<h&&(e.dw[c]+=1,--e.dw[a],d+=h)}return d},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=
a.layer_type;this.num_inputs=a.num_inputs}};f.RegressionLayer=b;f.SoftmaxLayer=c;f.SVMLayer=a})(convnetjs);
(function(f){var g=f.Vol,c=function(a){a=a||{};this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=a.in_depth;this.layer_type="relu"};c.prototype={forward:function(a,b){this.in_act=a;b=a.clone();a=a.w.length;for(var e=b.w,c=0;c<a;c++)0>e[c]&&(e[c]=0);return this.out_act=b},backward:function(){var a=this.in_act,b=this.out_act,c=a.w.length;a.dw=f.zeros(c);for(var d=0;d<c;d++)a.dw[d]=0>=b.w[d]?0:b.dw[d]},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;
a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type}};var b=function(a){a=a||{};this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=a.in_depth;this.layer_type="sigmoid"};b.prototype={forward:function(a,b){this.in_act=a;b=a.cloneAndZero();var e=a.w.length,c=b.w;a=a.w;for(var d=0;d<e;d++)c[d]=1/(1+Math.exp(-a[d]));return this.out_act=b},backward:function(){var a=
this.in_act,b=this.out_act,c=a.w.length;a.dw=f.zeros(c);for(var d=0;d<c;d++){var h=b.w[d];a.dw[d]=h*(1-h)*b.dw[d]}},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type}};var a=function(a){a=a||{};this.group_size="undefined"!==typeof a.group_size?a.group_size:2;
this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=Math.floor(a.in_depth/this.group_size);this.layer_type="maxout";this.switches=f.zeros(this.out_sx*this.out_sy*this.out_depth)};a.prototype={forward:function(a,b){this.in_act=a;b=this.out_depth;var d=new g(this.out_sx,this.out_sy,this.out_depth,0);if(1===this.out_sx&&1===this.out_sy)for(var c=0;c<b;c++){for(var e=c*this.group_size,f=a.w[e],p=0,u=1;u<this.group_size;u++){var k=a.w[e+u];k>f&&(f=k,p=u)}d.w[c]=f;this.switches[c]=e+p}else for(var v=
0,n=0;n<a.sx;n++)for(var w=0;w<a.sy;w++)for(c=0;c<b;c++){e=c*this.group_size;f=a.get(n,w,e);p=0;for(u=1;u<this.group_size;u++)k=a.get(n,w,e+u),k>f&&(f=k,p=u);d.set(n,w,c,f);this.switches[v]=e+p;v++}return this.out_act=d},backward:function(){var a=this.in_act,b=this.out_act,c=this.out_depth;a.dw=f.zeros(a.w.length);if(1===this.out_sx&&1===this.out_sy)for(var d=0;d<c;d++){var h=b.dw[d];a.dw[this.switches[d]]=h}else for(var q=0,p=0;p<b.sx;p++)for(var u=0;u<b.sy;u++)for(d=0;d<c;d++)h=b.get_grad(p,u,d),
a.set_grad(p,u,this.switches[q],h),q++},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.group_size=this.group_size;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.group_size=a.group_size;this.switches=f.zeros(this.group_size)}};var d=function(a){a=a||{};this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=
a.in_depth;this.layer_type="tanh"};d.prototype={forward:function(a,b){this.in_act=a;b=a.cloneAndZero();for(var d=a.w.length,c=0;c<d;c++){var e=Math.exp(2*a.w[c]);b.w[c]=(e-1)/(e+1)}return this.out_act=b},backward:function(){var a=this.in_act,b=this.out_act,c=a.w.length;a.dw=f.zeros(c);for(var d=0;d<c;d++){var h=b.w[d];a.dw[d]=(1-h*h)*b.dw[d]}},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;
return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type}};f.TanhLayer=d;f.MaxoutLayer=a;f.ReluLayer=c;f.SigmoidLayer=b})(convnetjs);
(function(f){var g=function(c){c=c||{};this.out_sx=c.in_sx;this.out_sy=c.in_sy;this.out_depth=c.in_depth;this.layer_type="dropout";this.drop_prob="undefined"!==typeof c.drop_prob?c.drop_prob:.5;this.dropped=f.zeros(this.out_sx*this.out_sy*this.out_depth)};g.prototype={forward:function(c,b){this.in_act=c;"undefined"===typeof b&&(b=!1);var a=c.clone();c=c.w.length;if(b)for(b=0;b<c;b++)Math.random()<this.drop_prob?(a.w[b]=0,this.dropped[b]=!0):this.dropped[b]=!1;else for(b=0;b<c;b++)a.w[b]*=this.drop_prob;
return this.out_act=a},backward:function(){var c=this.in_act,b=this.out_act,a=c.w.length;c.dw=f.zeros(a);for(var d=0;d<a;d++)this.dropped[d]||(c.dw[d]=b.dw[d])},getParamsAndGrads:function(){return[]},toJSON:function(){var c={};c.out_depth=this.out_depth;c.out_sx=this.out_sx;c.out_sy=this.out_sy;c.layer_type=this.layer_type;c.drop_prob=this.drop_prob;return c},fromJSON:function(c){this.out_depth=c.out_depth;this.out_sx=c.out_sx;this.out_sy=c.out_sy;this.layer_type=c.layer_type;this.drop_prob=c.drop_prob}};
f.DropoutLayer=g})(convnetjs);
(function(f){var g=function(c){c=c||{};this.k=c.k;this.n=c.n;this.alpha=c.alpha;this.beta=c.beta;this.out_sx=c.in_sx;this.out_sy=c.in_sy;this.out_depth=c.in_depth;this.layer_type="lrn";0===this.n%2&&console.log("WARNING n should be odd for LRN layer")};g.prototype={forward:function(c,b){this.in_act=c;b=c.cloneAndZero();this.S_cache_=c.cloneAndZero();for(var a=Math.floor(this.n/2),d=0;d<c.sx;d++)for(var e=0;e<c.sy;e++)for(var f=0;f<c.depth;f++){for(var g=c.get(d,e,f),l=0,h=Math.max(0,f-a);h<=Math.min(f+
a,c.depth-1);h++)var q=c.get(d,e,h),l=l+q*q;l*=this.alpha/this.n;l+=this.k;this.S_cache_.set(d,e,f,l);l=Math.pow(l,this.beta);b.set(d,e,f,g/l)}return this.out_act=b},backward:function(){var c=this.in_act;c.dw=f.zeros(c.w.length);for(var b=Math.floor(this.n/2),a=0;a<c.sx;a++)for(var d=0;d<c.sy;d++)for(var e=0;e<c.depth;e++)for(var g=this.out_act.get_grad(a,d,e),m=this.S_cache_.get(a,d,e),l=Math.pow(m,this.beta),h=l*l,q=Math.max(0,e-b);q<=Math.min(e+b,c.depth-1);q++){var p=c.get(a,d,q),p=-p*this.beta*
Math.pow(m,this.beta-1)*this.alpha/this.n*2*p;q===e&&(p+=l);p/=h;p*=g;c.add_grad(a,d,q,p)}},getParamsAndGrads:function(){return[]},toJSON:function(){var c={};c.k=this.k;c.n=this.n;c.alpha=this.alpha;c.beta=this.beta;c.out_sx=this.out_sx;c.out_sy=this.out_sy;c.out_depth=this.out_depth;c.layer_type=this.layer_type;return c},fromJSON:function(c){this.k=c.k;this.n=c.n;this.alpha=c.alpha;this.beta=c.beta;this.out_sx=c.out_sx;this.out_sy=c.out_sy;this.out_depth=c.out_depth;this.layer_type=c.layer_type}};
f.LocalResponseNormalizationLayer=g})(convnetjs);
(function(f){var g=f.assert,c=function(b){this.layers=[]};c.prototype={makeLayers:function(b){g(2<=b.length,"Error! At least one input layer and one loss layer are required.");g("input"===b[0].type,"Error! First layer must be the input layer, to declare size of inputs");for(var a=[],d=0;d<b.length;d++){var c=b[d];"softmax"!==c.type&&"svm"!==c.type||a.push({type:"fc",num_neurons:c.num_classes});"regression"===c.type&&a.push({type:"fc",num_neurons:c.num_neurons});"fc"!==c.type&&"conv"!==c.type||"undefined"!==
typeof c.bias_pref||(c.bias_pref=0,"undefined"!==typeof c.activation&&"relu"===c.activation&&(c.bias_pref=.1));a.push(c);"undefined"!==typeof c.activation&&("relu"===c.activation?a.push({type:"relu"}):"sigmoid"===c.activation?a.push({type:"sigmoid"}):"tanh"===c.activation?a.push({type:"tanh"}):"maxout"===c.activation?a.push({type:"maxout",group_size:"undefined"!==c.group_size?c.group_size:2}):console.log("ERROR unsupported activation "+c.activation));"undefined"!==typeof c.drop_prob&&"dropout"!==
c.type&&a.push({type:"dropout",drop_prob:c.drop_prob})}b=a;this.layers=[];for(a=0;a<b.length;a++)switch(d=b[a],0<a&&(c=this.layers[a-1],d.in_sx=c.out_sx,d.in_sy=c.out_sy,d.in_depth=c.out_depth),d.type){case "fc":this.layers.push(new f.FullyConnLayer(d));break;case "lrn":this.layers.push(new f.LocalResponseNormalizationLayer(d));break;case "dropout":this.layers.push(new f.DropoutLayer(d));break;case "input":this.layers.push(new f.InputLayer(d));break;case "softmax":this.layers.push(new f.SoftmaxLayer(d));
break;case "regression":this.layers.push(new f.RegressionLayer(d));break;case "conv":this.layers.push(new f.ConvLayer(d));break;case "pool":this.layers.push(new f.PoolLayer(d));break;case "relu":this.layers.push(new f.ReluLayer(d));break;case "sigmoid":this.layers.push(new f.SigmoidLayer(d));break;case "tanh":this.layers.push(new f.TanhLayer(d));break;case "maxout":this.layers.push(new f.MaxoutLayer(d));break;case "svm":this.layers.push(new f.SVMLayer(d));break;default:console.log("ERROR: UNRECOGNIZED LAYER TYPE: "+
d.type)}},forward:function(b,a){"undefined"===typeof a&&(a=!1);b=this.layers[0].forward(b,a);for(var c=1;c<this.layers.length;c++)b=this.layers[c].forward(b,a);return b},getCostLoss:function(b,a){this.forward(b,!1);return this.layers[this.layers.length-1].backward(a)},backward:function(b){var a=this.layers.length;b=this.layers[a-1].backward(b);for(a-=2;0<=a;a--)this.layers[a].backward();return b},getParamsAndGrads:function(){for(var b=[],a=0;a<this.layers.length;a++)for(var c=this.layers[a].getParamsAndGrads(),
e=0;e<c.length;e++)b.push(c[e]);return b},getPrediction:function(){var b=this.layers[this.layers.length-1];g("softmax"===b.layer_type,"getPrediction function assumes softmax as last layer of the net!");for(var b=b.out_act.w,a=b[0],c=0,e=1;e<b.length;e++)b[e]>a&&(a=b[e],c=e);return c},toJSON:function(){for(var c={layers:[]},a=0;a<this.layers.length;a++)c.layers.push(this.layers[a].toJSON());return c},fromJSON:function(c){this.layers=[];for(var a=0;a<c.layers.length;a++){var b=c.layers[a],e=b.layer_type,
g;"input"===e&&(g=new f.InputLayer);"relu"===e&&(g=new f.ReluLayer);"sigmoid"===e&&(g=new f.SigmoidLayer);"tanh"===e&&(g=new f.TanhLayer);"dropout"===e&&(g=new f.DropoutLayer);"conv"===e&&(g=new f.ConvLayer);"pool"===e&&(g=new f.PoolLayer);"lrn"===e&&(g=new f.LocalResponseNormalizationLayer);"softmax"===e&&(g=new f.SoftmaxLayer);"regression"===e&&(g=new f.RegressionLayer);"fc"===e&&(g=new f.FullyConnLayer);"maxout"===e&&(g=new f.MaxoutLayer);"svm"===e&&(g=new f.SVMLayer);g.fromJSON(b);this.layers.push(g)}}};
f.Net=c})(convnetjs);
(function(f){var g=function(c,b){this.net=c;b=b||{};this.learning_rate="undefined"!==typeof b.learning_rate?b.learning_rate:.01;this.l1_decay="undefined"!==typeof b.l1_decay?b.l1_decay:0;this.l2_decay="undefined"!==typeof b.l2_decay?b.l2_decay:0;this.batch_size="undefined"!==typeof b.batch_size?b.batch_size:1;this.method="undefined"!==typeof b.method?b.method:"sgd";this.momentum="undefined"!==typeof b.momentum?b.momentum:.9;this.ro="undefined"!==typeof b.ro?b.ro:.95;this.eps="undefined"!==typeof b.eps?
b.eps:1e-8;this.beta1="undefined"!==typeof b.beta1?b.beta1:.9;this.beta2="undefined"!==typeof b.beta2?b.beta2:.999;this.k=0;this.gsum=[];this.xsum=[];this.regression="regression"===this.net.layers[this.net.layers.length-1].layer_type?!0:!1};g.prototype={train:function(c,b){var a=(new Date).getTime();this.net.forward(c,!0);var d=(new Date).getTime();c=d-a;var a=(new Date).getTime(),e=this.net.backward(b),g=0,m=0,d=(new Date).getTime(),a=d-a;this.regression&&b.constructor!==Array&&console.log("Warning: a regression net requires an array as training output vector.");
this.k++;if(0===this.k%this.batch_size){b=this.net.getParamsAndGrads();if(0===this.gsum.length&&("sgd"!==this.method||0<this.momentum))for(d=0;d<b.length;d++)this.gsum.push(f.zeros(b[d].params.length)),"adam"===this.method||"adadelta"===this.method?this.xsum.push(f.zeros(b[d].params.length)):this.xsum.push([]);for(d=0;d<b.length;d++)for(var l=b[d],h=l.params,q=l.grads,p=this.l2_decay*("undefined"!==typeof l.l2_decay_mul?l.l2_decay_mul:1),l=this.l1_decay*("undefined"!==typeof l.l1_decay_mul?l.l1_decay_mul:
1),u=h.length,k=0;k<u;k++){var g=g+p*h[k]*h[k]/2,m=m+l*Math.abs(h[k]),r=(p*h[k]+l*(0<h[k]?1:-1)+q[k])/this.batch_size,n=this.gsum[d],w=this.xsum[d];if("adam"===this.method){n[k]=n[k]*this.beta1+(1-this.beta1)*r;w[k]=w[k]*this.beta2+(1-this.beta2)*r*r;var t=-this.learning_rate*n[k]*(1-Math.pow(this.beta1,this.k))/(Math.sqrt(w[k]*(1-Math.pow(this.beta2,this.k)))+this.eps);h[k]+=t}else"adagrad"===this.method?(n[k]+=r*r,t=-this.learning_rate/Math.sqrt(n[k]+this.eps)*r,h[k]+=t):"windowgrad"===this.method?
(n[k]=this.ro*n[k]+(1-this.ro)*r*r,t=-this.learning_rate/Math.sqrt(n[k]+this.eps)*r,h[k]+=t):"adadelta"===this.method?(n[k]=this.ro*n[k]+(1-this.ro)*r*r,t=-Math.sqrt((w[k]+this.eps)/(n[k]+this.eps))*r,w[k]=this.ro*w[k]+(1-this.ro)*t*t,h[k]+=t):"nesterov"===this.method?(t=n[k],n[k]=n[k]*this.momentum+this.learning_rate*r,t=this.momentum*t-(1+this.momentum)*n[k],h[k]+=t):0<this.momentum?(t=this.momentum*n[k]-this.learning_rate*r,n[k]=t,h[k]+=t):h[k]+=-this.learning_rate*r;q[k]=0}}return{fwd_time:c,
bwd_time:a,l2_decay_loss:g,l1_decay_loss:m,cost_loss:e,softmax_loss:e,loss:e+m+g}}};f.Trainer=g;f.SGDTrainer=g})(convnetjs);
(function(f){var g=f.randf,c=f.randi,b=f.Net,a=f.Trainer,d=f.maxmin,e=f.randperm,v=f.weightedSample,m=f.getopt,l=f.arrUnique,h=function(a,c,b){b=b||{};"undefined"===typeof a&&(a=[]);"undefined"===typeof c&&(c=[]);this.data=a;this.labels=c;this.train_ratio=m(b,"train_ratio",.7);this.num_folds=m(b,"num_folds",10);this.num_candidates=m(b,"num_candidates",50);this.num_epochs=m(b,"num_epochs",50);this.ensemble_size=m(b,"ensemble_size",10);this.batch_size_min=m(b,"batch_size_min",10);this.batch_size_max=
m(b,"batch_size_max",300);this.l2_decay_min=m(b,"l2_decay_min",-4);this.l2_decay_max=m(b,"l2_decay_max",2);this.learning_rate_min=m(b,"learning_rate_min",-4);this.learning_rate_max=m(b,"learning_rate_max",0);this.momentum_min=m(b,"momentum_min",.9);this.momentum_max=m(b,"momentum_max",.9);this.neurons_min=m(b,"neurons_min",5);this.neurons_max=m(b,"neurons_max",30);this.folds=[];this.candidates=[];this.evaluated_candidates=[];this.unique_labels=l(c);this.foldix=this.iter=0;this.finish_batch_callback=
this.finish_fold_callback=null;0<this.data.length&&(this.sampleFolds(),this.sampleCandidates())};h.prototype={sampleFolds:function(){var a=this.data.length,b=Math.floor(this.train_ratio*a);this.folds=[];for(var c=0;c<this.num_folds;c++){var d=e(a);this.folds.push({train_ix:d.slice(0,b),test_ix:d.slice(b,a)})}},sampleCandidate:function(){var d=this.unique_labels.length,e=[];e.push({type:"input",out_sx:1,out_sy:1,out_depth:this.data[0].w.length});for(var f=v([0,1,2,3],[.2,.3,.3,.2]),k=0;k<f;k++){var h=
c(this.neurons_min,this.neurons_max),n=["tanh","maxout","relu"][c(0,3)];.5>g(0,1)?e.push({type:"fc",num_neurons:h,activation:n,drop_prob:Math.random()}):e.push({type:"fc",num_neurons:h,activation:n})}e.push({type:"softmax",num_classes:d});d=new b;d.makeLayers(e);var f=c(this.batch_size_min,this.batch_size_max),k=Math.pow(10,g(this.l2_decay_min,this.l2_decay_max)),h=Math.pow(10,g(this.learning_rate_min,this.learning_rate_max)),n=g(this.momentum_min,this.momentum_max),l=g(0,1),f=.33>l?{method:"adadelta",
batch_size:f,l2_decay:k}:.66>l?{method:"adagrad",learning_rate:h,batch_size:f,l2_decay:k}:{method:"sgd",learning_rate:h,momentum:n,batch_size:f,l2_decay:k},k=new a(d,f),h={acc:[],accv:0};h.layer_defs=e;h.trainer_def=f;h.net=d;h.trainer=k;return h},sampleCandidates:function(){this.candidates=[];for(var a=0;a<this.num_candidates;a++){var b=this.sampleCandidate();this.candidates.push(b)}},step:function(){this.iter++;for(var d=this.folds[this.foldix],e=d.train_ix[c(0,d.train_ix.length)],f=0;f<this.candidates.length;f++)this.candidates[f].trainer.train(this.data[e],
this.labels[e]);if(this.iter>=this.num_epochs*d.train_ix.length){e=this.evalValErrors();for(f=0;f<this.candidates.length;f++)d=this.candidates[f],d.acc.push(e[f]),d.accv+=e[f];this.iter=0;this.foldix++;null!==this.finish_fold_callback&&this.finish_fold_callback();if(this.foldix>=this.folds.length){for(f=0;f<this.candidates.length;f++)this.evaluated_candidates.push(this.candidates[f]);this.evaluated_candidates.sort(function(a,b){return a.accv/a.acc.length>b.accv/b.acc.length?-1:1});this.evaluated_candidates.length>
3*this.ensemble_size&&(this.evaluated_candidates=this.evaluated_candidates.slice(0,3*this.ensemble_size));null!==this.finish_batch_callback&&this.finish_batch_callback();this.sampleCandidates();this.foldix=0}else for(f=0;f<this.candidates.length;f++){d=this.candidates[f];e=new b;e.makeLayers(d.layer_defs);var k=new a(e,d.trainer_def);d.net=e;d.trainer=k}}},evalValErrors:function(){for(var a=[],b=this.folds[this.foldix],c=0;c<this.candidates.length;c++){for(var d=this.candidates[c].net,e=0,f=0;f<b.test_ix.length;f++){var g=
this.labels[b.test_ix[f]];d.forward(this.data[b.test_ix[f]]);var h=d.getPrediction(),e=e+(h===g?1:0)}e/=b.test_ix.length;a.push(e)}return a},predict_soft:function(a){var b,c;0===this.evaluated_candidates.length?(c=this.candidates.length,b=this.candidates):(c=Math.min(this.ensemble_size,this.evaluated_candidates.length),b=this.evaluated_candidates);for(var d,e,f=0;f<c;f++){var g=b[f].net.forward(a);if(0===f)d=g,e=g.w.length;else for(var h=0;h<e;h++)d.w[h]+=g.w[h]}for(h=0;h<e;h++)d.w[h]/=c;return d},
predict:function(a){a=this.predict_soft(a);return 0!==a.w.length?d(a.w).maxi:-1},toJSON:function(){for(var a=Math.min(this.ensemble_size,this.evaluated_candidates.length),b={nets:[]},c=0;c<a;c++)b.nets.push(this.evaluated_candidates[c].net.toJSON());return b},fromJSON:function(a){this.ensemble_size=a.nets.length;this.evaluated_candidates=[];for(var c=0;c<this.ensemble_size;c++){var d=new b;d.fromJSON(a.nets[c]);var e={};e.net=d;this.evaluated_candidates.push(e)}},onFinishFold:function(a){this.finish_fold_callback=
a},onFinishBatch:function(a){this.finish_batch_callback=a}};f.MagicNet=h})(convnetjs);(function(f){"undefined"===typeof module||"undefined"===typeof module.exports?window.convnetjs=f:module.exports=f})(convnetjs);