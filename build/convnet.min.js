(function(e){"undefined"===typeof module||"undefined"===typeof module.exports?window.convnetjs=e:module.exports=e})(convnetjs);var convnetjs=convnetjs||{REVISION:"ALPHA"};
(function(e){var h=e.Vol,b=function(a){a=a||{};this.out_depth=a.filters;this.sx=a.sx;this.in_depth=a.in_depth;this.in_sx=a.in_sx;this.in_sy=a.in_sy;this.sy="undefined"!==typeof a.sy?a.sy:this.sx;this.stride="undefined"!==typeof a.stride?a.stride:1;this.pad="undefined"!==typeof a.pad?a.pad:0;this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:0;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.out_sx=Math.floor((this.in_sx+2*this.pad-this.sx)/this.stride+
1);this.out_sy=Math.floor((this.in_sy+2*this.pad-this.sy)/this.stride+1);this.layer_type="conv";a="undefined"!==typeof a.bias_pref?a.bias_pref:0;this.filters=[];for(var d=0;d<this.out_depth;d++)this.filters.push(new h(this.sx,this.sy,this.in_depth));this.biases=new h(1,1,this.out_depth,a)};b.prototype={forward:function(a,d){this.in_act=a;d=new h(this.out_sx|0,this.out_sy|0,this.out_depth|0,0);for(var f=a.sx|0,c=a.sy|0,b=this.stride|0,g=0;g<this.out_depth;g++)for(var e=this.filters[g],u,v=-this.pad|
0,t=0;t<this.out_sy;v+=b,t++){u=-this.pad|0;for(var m=0;m<this.out_sx;u+=b,m++){for(var q=0,p=0;p<e.sy;p++)for(var w=v+p,r=0;r<e.sx;r++){var x=u+r;if(0<=w&&w<c&&0<=x&&x<f)for(var y=0;y<e.depth;y++)q+=e.w[(e.sx*p+r)*e.depth+y]*a.w[(f*w+x)*a.depth+y]}q+=this.biases.w[g];d.set(m,t,g,q)}}return this.out_act=d},backward:function(){var a=this.in_act;a.dw=e.zeros(a.w.length);for(var d=a.sx|0,f=a.sy|0,c=this.stride|0,b=0;b<this.out_depth;b++)for(var g=this.filters[b],k,u=-this.pad|0,v=0;v<this.out_sy;u+=
c,v++){k=-this.pad|0;for(var t=0;t<this.out_sx;k+=c,t++){for(var m=this.out_act.get_grad(t,v,b),q=0;q<g.sy;q++)for(var p=u+q,h=0;h<g.sx;h++){var r=k+h;if(0<=p&&p<f&&0<=r&&r<d)for(var x=0;x<g.depth;x++){var y=(d*p+r)*a.depth+x,z=(g.sx*q+h)*g.depth+x;g.dw[z]+=a.w[y]*m;a.dw[y]+=g.w[z]*m}}this.biases.dw[b]+=m}}},getParamsAndGrads:function(){for(var a=[],d=0;d<this.out_depth;d++)a.push({params:this.filters[d].w,grads:this.filters[d].dw,l2_decay_mul:this.l2_decay_mul,l1_decay_mul:this.l1_decay_mul});a.push({params:this.biases.w,
grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0});return a},toJSON:function(){var a={};a.sx=this.sx;a.sy=this.sy;a.stride=this.stride;a.in_depth=this.in_depth;a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.l1_decay_mul=this.l1_decay_mul;a.l2_decay_mul=this.l2_decay_mul;a.pad=this.pad;a.filters=[];for(var d=0;d<this.filters.length;d++)a.filters.push(this.filters[d].toJSON());a.biases=this.biases.toJSON();return a},fromJSON:function(a){this.out_depth=
a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.sx=a.sx;this.sy=a.sy;this.stride=a.stride;this.in_depth=a.in_depth;this.filters=[];this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:1;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.pad="undefined"!==typeof a.pad?a.pad:0;for(var d=0;d<a.filters.length;d++){var f=new h(0,0,0,0);f.fromJSON(a.filters[d]);this.filters.push(f)}this.biases=new h(0,0,0,0);this.biases.fromJSON(a.biases)}};
var c=function(a){a=a||{};this.out_depth="undefined"!==typeof a.num_neurons?a.num_neurons:a.filters;this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:0;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="fc";a="undefined"!==typeof a.bias_pref?a.bias_pref:0;this.filters=[];for(var d=0;d<this.out_depth;d++)this.filters.push(new h(1,1,this.num_inputs));this.biases=new h(1,1,this.out_depth,
a)};c.prototype={forward:function(a,d){this.in_act=a;d=new h(1,1,this.out_depth,0);a=a.w;for(var f=0;f<this.out_depth;f++){for(var c=0,b=this.filters[f].w,g=0;g<this.num_inputs;g++)c+=a[g]*b[g];c+=this.biases.w[f];d.w[f]=c}return this.out_act=d},backward:function(){var a=this.in_act;a.dw=e.zeros(a.w.length);for(var d=0;d<this.out_depth;d++){for(var f=this.filters[d],c=this.out_act.dw[d],b=0;b<this.num_inputs;b++)a.dw[b]+=f.w[b]*c,f.dw[b]+=a.w[b]*c;this.biases.dw[d]+=c}},getParamsAndGrads:function(){for(var a=
[],d=0;d<this.out_depth;d++)a.push({params:this.filters[d].w,grads:this.filters[d].dw,l1_decay_mul:this.l1_decay_mul,l2_decay_mul:this.l2_decay_mul});a.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0});return a},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;a.l1_decay_mul=this.l1_decay_mul;a.l2_decay_mul=this.l2_decay_mul;a.filters=[];for(var d=0;d<this.filters.length;d++)a.filters.push(this.filters[d].toJSON());
a.biases=this.biases.toJSON();return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.num_inputs=a.num_inputs;this.l1_decay_mul="undefined"!==typeof a.l1_decay_mul?a.l1_decay_mul:1;this.l2_decay_mul="undefined"!==typeof a.l2_decay_mul?a.l2_decay_mul:1;this.filters=[];for(var d=0;d<a.filters.length;d++){var f=new h(0,0,0,0);f.fromJSON(a.filters[d]);this.filters.push(f)}this.biases=new h(0,0,0,0);this.biases.fromJSON(a.biases)}};
e.ConvLayer=b;e.FullyConnLayer=c})(convnetjs);
(function(e){var h=function(b){b=b||{};this.out_sx=b.in_sx;this.out_sy=b.in_sy;this.out_depth=b.in_depth;this.layer_type="dropout";this.drop_prob="undefined"!==typeof b.drop_prob?b.drop_prob:.5;this.dropped=e.zeros(this.out_sx*this.out_sy*this.out_depth)};h.prototype={forward:function(b,c){this.in_act=b;"undefined"===typeof c&&(c=!1);var a=b.clone();b=b.w.length;if(c)for(c=0;c<b;c++)Math.random()<this.drop_prob?(a.w[c]=0,this.dropped[c]=!0):this.dropped[c]=!1;else for(c=0;c<b;c++)a.w[c]*=this.drop_prob;
return this.out_act=a},backward:function(){var b=this.in_act,c=this.out_act,a=b.w.length;b.dw=e.zeros(a);for(var d=0;d<a;d++)this.dropped[d]||(b.dw[d]=c.dw[d])},getParamsAndGrads:function(){return[]},toJSON:function(){var b={};b.out_depth=this.out_depth;b.out_sx=this.out_sx;b.out_sy=this.out_sy;b.layer_type=this.layer_type;b.drop_prob=this.drop_prob;return b},fromJSON:function(b){this.out_depth=b.out_depth;this.out_sx=b.out_sx;this.out_sy=b.out_sy;this.layer_type=b.layer_type;this.drop_prob=b.drop_prob}};
e.DropoutLayer=h})(convnetjs);
(function(e){var h=e.getopt,b=function(c){c=c||{};this.out_depth=h(c,["out_depth","depth"],0);this.out_sx=h(c,["out_sx","sx","width"],1);this.out_sy=h(c,["out_sy","sy","height"],1);this.layer_type="input"};b.prototype={forward:function(c,a){return this.out_act=this.in_act=c},backward:function(){},getParamsAndGrads:function(){return[]},toJSON:function(){var c={};c.out_depth=this.out_depth;c.out_sx=this.out_sx;c.out_sy=this.out_sy;c.layer_type=this.layer_type;return c},fromJSON:function(c){this.out_depth=
c.out_depth;this.out_sx=c.out_sx;this.out_sy=c.out_sy;this.layer_type=c.layer_type}};e.InputLayer=b})(convnetjs);
(function(e){var h=e.Vol,b=function(a){a=a||{};this.out_depth=this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="softmax"};b.prototype={forward:function(a,f){this.in_act=a;f=new h(1,1,this.out_depth,0);var c=a.w;a=a.w[0];for(var d=1;d<this.out_depth;d++)c[d]>a&&(a=c[d]);for(var b=e.zeros(this.out_depth),k=0,d=0;d<this.out_depth;d++){var u=Math.exp(c[d]-a),k=k+u;b[d]=u}for(d=0;d<this.out_depth;d++)b[d]/=k,f.w[d]=b[d];this.es=b;return this.out_act=f},backward:function(a){var f=
this.in_act;f.dw=e.zeros(f.w.length);for(var c=0;c<this.out_depth;c++)f.dw[c]=-((c===a?1:0)-this.es[c]);return-Math.log(this.es[a])},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.num_inputs=a.num_inputs}};var c=function(a){a=
a||{};this.out_depth=this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="regression"};c.prototype={forward:function(a,f){return this.out_act=this.in_act=a},backward:function(a){var f=this.in_act;f.dw=e.zeros(f.w.length);var c=0;if(a instanceof Array||a instanceof Float64Array)for(var d=0;d<this.out_depth;d++){var b=f.w[d]-a[d];f.dw[d]=b;c+=.5*b*b}else"number"===typeof a?(b=f.w[0]-a,f.dw[0]=b):(d=a.dim,b=f.w[d]-a.val,f.dw[d]=b),c+=.5*b*b;return c},getParamsAndGrads:function(){return[]},
toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.num_inputs=a.num_inputs}};var a=function(a){a=a||{};this.out_depth=this.num_inputs=a.in_sx*a.in_sy*a.in_depth;this.out_sy=this.out_sx=1;this.layer_type="svm"};a.prototype={forward:function(a,f){return this.out_act=
this.in_act=a},backward:function(a){var f=this.in_act;f.dw=e.zeros(f.w.length);for(var c=f.w[a],b=0,d=0;d<this.out_depth;d++)if(a!==d){var k=-c+f.w[d]+1;0<k&&(f.dw[d]+=1,--f.dw[a],b+=k)}return b},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.num_inputs=this.num_inputs;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=
a.layer_type;this.num_inputs=a.num_inputs}};e.RegressionLayer=c;e.SoftmaxLayer=b;e.SVMLayer=a})(convnetjs);
(function(e){var h=e.Vol,b=function(a){a=a||{};this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=a.in_depth;this.layer_type="relu"};b.prototype={forward:function(a,c){this.in_act=a;c=a.clone();a=a.w.length;for(var f=c.w,b=0;b<a;b++)0>f[b]&&(f[b]=0);return this.out_act=c},backward:function(){var a=this.in_act,c=this.out_act,b=a.w.length;a.dw=e.zeros(b);for(var d=0;d<b;d++)a.dw[d]=0>=c.w[d]?0:c.dw[d]},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;
a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type}};var c=function(a){a=a||{};this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=a.in_depth;this.layer_type="sigmoid"};c.prototype={forward:function(a,c){this.in_act=a;c=a.cloneAndZero();var f=a.w.length,b=c.w;a=a.w;for(var d=0;d<f;d++)b[d]=1/(1+Math.exp(-a[d]));return this.out_act=c},backward:function(){var a=
this.in_act,c=this.out_act,b=a.w.length;a.dw=e.zeros(b);for(var d=0;d<b;d++){var k=c.w[d];a.dw[d]=k*(1-k)*c.dw[d]}},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type}};var a=function(a){a=a||{};this.group_size="undefined"!==typeof a.group_size?a.group_size:2;
this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=Math.floor(a.in_depth/this.group_size);this.layer_type="maxout";this.switches=e.zeros(this.out_sx*this.out_sy*this.out_depth)};a.prototype={forward:function(a,c){this.in_act=a;c=this.out_depth;var f=new h(this.out_sx,this.out_sy,this.out_depth,0);if(1===this.out_sx&&1===this.out_sy)for(var b=0;b<c;b++){for(var d=b*this.group_size,e=a.w[d],n=0,t=1;t<this.group_size;t++){var m=a.w[d+t];m>e&&(e=m,n=t)}f.w[b]=e;this.switches[b]=d+n}else for(var q=
0,p=0;p<a.sx;p++)for(var w=0;w<a.sy;w++)for(b=0;b<c;b++){d=b*this.group_size;e=a.get(p,w,d);n=0;for(t=1;t<this.group_size;t++)m=a.get(p,w,d+t),m>e&&(e=m,n=t);f.set(p,w,b,e);this.switches[q]=d+n;q++}return this.out_act=f},backward:function(){var a=this.in_act,c=this.out_act,b=this.out_depth;a.dw=e.zeros(a.w.length);if(1===this.out_sx&&1===this.out_sy)for(var d=0;d<b;d++){var k=c.dw[d];a.dw[this.switches[d]]=k}else for(var u=0,v=0;v<c.sx;v++)for(var t=0;t<c.sy;t++)for(d=0;d<b;d++)k=c.get_grad(v,t,d),
a.set_grad(v,t,this.switches[u],k),u++},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;a.group_size=this.group_size;return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type;this.group_size=a.group_size;this.switches=e.zeros(this.group_size)}};var d=function(a){a=a||{};this.out_sx=a.in_sx;this.out_sy=a.in_sy;this.out_depth=
a.in_depth;this.layer_type="tanh"};d.prototype={forward:function(a,c){this.in_act=a;c=a.cloneAndZero();for(var b=a.w.length,d=0;d<b;d++){var f=Math.exp(2*a.w[d]);c.w[d]=(f-1)/(f+1)}return this.out_act=c},backward:function(){var a=this.in_act,c=this.out_act,b=a.w.length;a.dw=e.zeros(b);for(var d=0;d<b;d++){var k=c.w[d];a.dw[d]=(1-k*k)*c.dw[d]}},getParamsAndGrads:function(){return[]},toJSON:function(){var a={};a.out_depth=this.out_depth;a.out_sx=this.out_sx;a.out_sy=this.out_sy;a.layer_type=this.layer_type;
return a},fromJSON:function(a){this.out_depth=a.out_depth;this.out_sx=a.out_sx;this.out_sy=a.out_sy;this.layer_type=a.layer_type}};e.TanhLayer=d;e.MaxoutLayer=a;e.ReluLayer=b;e.SigmoidLayer=c})(convnetjs);
(function(e){var h=function(b){b=b||{};this.k=b.k;this.n=b.n;this.alpha=b.alpha;this.beta=b.beta;this.out_sx=b.in_sx;this.out_sy=b.in_sy;this.out_depth=b.in_depth;this.layer_type="lrn";0===this.n%2&&console.log("WARNING n should be odd for LRN layer")};h.prototype={forward:function(b,c){this.in_act=b;c=b.cloneAndZero();this.S_cache_=b.cloneAndZero();for(var a=Math.floor(this.n/2),d=0;d<b.sx;d++)for(var f=0;f<b.sy;f++)for(var e=0;e<b.depth;e++){for(var l=b.get(d,f,e),g=0,k=Math.max(0,e-a);k<=Math.min(e+
a,b.depth-1);k++)var u=b.get(d,f,k),g=g+u*u;g*=this.alpha/this.n;g+=this.k;this.S_cache_.set(d,f,e,g);g=Math.pow(g,this.beta);c.set(d,f,e,l/g)}return this.out_act=c},backward:function(){var b=this.in_act;b.dw=e.zeros(b.w.length);for(var c=Math.floor(this.n/2),a=0;a<b.sx;a++)for(var d=0;d<b.sy;d++)for(var f=0;f<b.depth;f++)for(var n=this.out_act.get_grad(a,d,f),l=this.S_cache_.get(a,d,f),g=Math.pow(l,this.beta),k=g*g,u=Math.max(0,f-c);u<=Math.min(f+c,b.depth-1);u++){var v=b.get(a,d,u),v=-v*this.beta*
Math.pow(l,this.beta-1)*this.alpha/this.n*2*v;u===f&&(v+=g);v/=k;v*=n;b.add_grad(a,d,u,v)}},getParamsAndGrads:function(){return[]},toJSON:function(){var b={};b.k=this.k;b.n=this.n;b.alpha=this.alpha;b.beta=this.beta;b.out_sx=this.out_sx;b.out_sy=this.out_sy;b.out_depth=this.out_depth;b.layer_type=this.layer_type;return b},fromJSON:function(b){this.k=b.k;this.n=b.n;this.alpha=b.alpha;this.beta=b.beta;this.out_sx=b.out_sx;this.out_sy=b.out_sy;this.out_depth=b.out_depth;this.layer_type=b.layer_type}};
e.LocalResponseNormalizationLayer=h})(convnetjs);
(function(e){var h=e.Vol,b=function(c){c=c||{};this.sx=c.sx;this.in_depth=c.in_depth;this.in_sx=c.in_sx;this.in_sy=c.in_sy;this.sy="undefined"!==typeof c.sy?c.sy:this.sx;this.stride="undefined"!==typeof c.stride?c.stride:2;this.pad="undefined"!==typeof c.pad?c.pad:0;this.out_depth=this.in_depth;this.out_sx=Math.floor((this.in_sx+2*this.pad-this.sx)/this.stride+1);this.out_sy=Math.floor((this.in_sy+2*this.pad-this.sy)/this.stride+1);this.layer_type="pool";this.switchx=e.zeros(this.out_sx*this.out_sy*
this.out_depth);this.switchy=e.zeros(this.out_sx*this.out_sy*this.out_depth)};b.prototype={forward:function(c,a){this.in_act=c;a=new h(this.out_sx,this.out_sy,this.out_depth,0);for(var b=0,f=0;f<this.out_depth;f++)for(var e=-this.pad,l,g=0;g<this.out_sx;e+=this.stride,g++){l=-this.pad;for(var k=0;k<this.out_sy;l+=this.stride,k++){for(var u=-99999,v=-1,t=-1,m=0;m<this.sx;m++)for(var q=0;q<this.sy;q++){var p=l+q,w=e+m;if(0<=p&&p<c.sy&&0<=w&&w<c.sx){var r=c.get(w,p,f);r>u&&(u=r,v=w,t=p)}}this.switchx[b]=
v;this.switchy[b]=t;b++;a.set(g,k,f,u)}}return this.out_act=a},backward:function(){var c=this.in_act;c.dw=e.zeros(c.w.length);for(var a=0,b=0;b<this.out_depth;b++)for(var f=0;f<this.out_sx;f++)for(var n=0;n<this.out_sy;n++){var l=this.out_act.get_grad(f,n,b);c.add_grad(this.switchx[a],this.switchy[a],b,l);a++}},getParamsAndGrads:function(){return[]},toJSON:function(){var c={};c.sx=this.sx;c.sy=this.sy;c.stride=this.stride;c.in_depth=this.in_depth;c.out_depth=this.out_depth;c.out_sx=this.out_sx;c.out_sy=
this.out_sy;c.layer_type=this.layer_type;c.pad=this.pad;return c},fromJSON:function(c){this.out_depth=c.out_depth;this.out_sx=c.out_sx;this.out_sy=c.out_sy;this.layer_type=c.layer_type;this.sx=c.sx;this.sy=c.sy;this.stride=c.stride;this.in_depth=c.in_depth;this.pad="undefined"!==typeof c.pad?c.pad:0;this.switchx=e.zeros(this.out_sx*this.out_sy*this.out_depth);this.switchy=e.zeros(this.out_sx*this.out_sy*this.out_depth)}};e.PoolLayer=b})(convnetjs);
(function(e){var h=e.randf,b=e.randi,c=e.Net,a=e.Trainer,d=e.maxmin,f=e.randperm,n=e.weightedSample,l=e.getopt,g=e.arrUnique,k=function(a,c,b){b=b||{};"undefined"===typeof a&&(a=[]);"undefined"===typeof c&&(c=[]);this.data=a;this.labels=c;this.train_ratio=l(b,"train_ratio",.7);this.num_folds=l(b,"num_folds",10);this.num_candidates=l(b,"num_candidates",50);this.num_epochs=l(b,"num_epochs",50);this.ensemble_size=l(b,"ensemble_size",10);this.batch_size_min=l(b,"batch_size_min",10);this.batch_size_max=
l(b,"batch_size_max",300);this.l2_decay_min=l(b,"l2_decay_min",-4);this.l2_decay_max=l(b,"l2_decay_max",2);this.learning_rate_min=l(b,"learning_rate_min",-4);this.learning_rate_max=l(b,"learning_rate_max",0);this.momentum_min=l(b,"momentum_min",.9);this.momentum_max=l(b,"momentum_max",.9);this.neurons_min=l(b,"neurons_min",5);this.neurons_max=l(b,"neurons_max",30);this.folds=[];this.candidates=[];this.evaluated_candidates=[];this.unique_labels=g(c);this.foldix=this.iter=0;this.finish_batch_callback=
this.finish_fold_callback=null;0<this.data.length&&(this.sampleFolds(),this.sampleCandidates())};k.prototype={sampleFolds:function(){var a=this.data.length,c=Math.floor(this.train_ratio*a);this.folds=[];for(var b=0;b<this.num_folds;b++){var d=f(a);this.folds.push({train_ix:d.slice(0,c),test_ix:d.slice(c,a)})}},sampleCandidate:function(){var d=this.unique_labels.length,f=[];f.push({type:"input",out_sx:1,out_sy:1,out_depth:this.data[0].w.length});for(var e=n([0,1,2,3],[.2,.3,.3,.2]),l=0;l<e;l++){var g=
b(this.neurons_min,this.neurons_max),k=["tanh","maxout","relu"][b(0,3)];.5>h(0,1)?f.push({type:"fc",num_neurons:g,activation:k,drop_prob:Math.random()}):f.push({type:"fc",num_neurons:g,activation:k})}f.push({type:"softmax",num_classes:d});d=new c;d.makeLayers(f);var e=b(this.batch_size_min,this.batch_size_max),l=Math.pow(10,h(this.l2_decay_min,this.l2_decay_max)),g=Math.pow(10,h(this.learning_rate_min,this.learning_rate_max)),k=h(this.momentum_min,this.momentum_max),w=h(0,1),e=.33>w?{method:"adadelta",
batch_size:e,l2_decay:l}:.66>w?{method:"adagrad",learning_rate:g,batch_size:e,l2_decay:l}:{method:"sgd",learning_rate:g,momentum:k,batch_size:e,l2_decay:l},l=new a(d,e),g={acc:[],accv:0};g.layer_defs=f;g.trainer_def=e;g.net=d;g.trainer=l;return g},sampleCandidates:function(){this.candidates=[];for(var a=0;a<this.num_candidates;a++){var c=this.sampleCandidate();this.candidates.push(c)}},step:function(){this.iter++;for(var d=this.folds[this.foldix],f=d.train_ix[b(0,d.train_ix.length)],e=0;e<this.candidates.length;e++)this.candidates[e].trainer.train(this.data[f],
this.labels[f]);if(this.iter>=this.num_epochs*d.train_ix.length){f=this.evalValErrors();for(e=0;e<this.candidates.length;e++)d=this.candidates[e],d.acc.push(f[e]),d.accv+=f[e];this.iter=0;this.foldix++;null!==this.finish_fold_callback&&this.finish_fold_callback();if(this.foldix>=this.folds.length){for(e=0;e<this.candidates.length;e++)this.evaluated_candidates.push(this.candidates[e]);this.evaluated_candidates.sort(function(a,c){return a.accv/a.acc.length>c.accv/c.acc.length?-1:1});this.evaluated_candidates.length>
3*this.ensemble_size&&(this.evaluated_candidates=this.evaluated_candidates.slice(0,3*this.ensemble_size));null!==this.finish_batch_callback&&this.finish_batch_callback();this.sampleCandidates();this.foldix=0}else for(e=0;e<this.candidates.length;e++){d=this.candidates[e];f=new c;f.makeLayers(d.layer_defs);var l=new a(f,d.trainer_def);d.net=f;d.trainer=l}}},evalValErrors:function(){for(var a=[],c=this.folds[this.foldix],b=0;b<this.candidates.length;b++){for(var d=this.candidates[b].net,f=0,e=0;e<c.test_ix.length;e++){var l=
this.labels[c.test_ix[e]];d.forward(this.data[c.test_ix[e]]);var n=d.getPrediction(),f=f+(n===l?1:0)}f/=c.test_ix.length;a.push(f)}return a},predict_soft:function(a){var c,b;0===this.evaluated_candidates.length?(b=this.candidates.length,c=this.candidates):(b=Math.min(this.ensemble_size,this.evaluated_candidates.length),c=this.evaluated_candidates);for(var d,f,e=0;e<b;e++){var l=c[e].net.forward(a);if(0===e)d=l,f=l.w.length;else for(var n=0;n<f;n++)d.w[n]+=l.w[n]}for(n=0;n<f;n++)d.w[n]/=b;return d},
predict:function(a){a=this.predict_soft(a);return 0!==a.w.length?d(a.w).maxi:-1},toJSON:function(){for(var a=Math.min(this.ensemble_size,this.evaluated_candidates.length),c={nets:[]},b=0;b<a;b++)c.nets.push(this.evaluated_candidates[b].net.toJSON());return c},fromJSON:function(a){this.ensemble_size=a.nets.length;this.evaluated_candidates=[];for(var b=0;b<this.ensemble_size;b++){var d=new c;d.fromJSON(a.nets[b]);var f={};f.net=d;this.evaluated_candidates.push(f)}},onFinishFold:function(a){this.finish_fold_callback=
a},onFinishBatch:function(a){this.finish_batch_callback=a}};e.MagicNet=k})(convnetjs);
(function(e){var h=e.assert,b=function(c){this.layers=[]};b.prototype={makeLayers:function(c){h(2<=c.length,"Error! At least one input layer and one loss layer are required.");h("input"===c[0].type,"Error! First layer must be the input layer, to declare size of inputs");for(var a=[],b=0;b<c.length;b++){var f=c[b];"softmax"!==f.type&&"svm"!==f.type||a.push({type:"fc",num_neurons:f.num_classes});"regression"===f.type&&a.push({type:"fc",num_neurons:f.num_neurons});"fc"!==f.type&&"conv"!==f.type||"undefined"!==
typeof f.bias_pref||(f.bias_pref=0,"undefined"!==typeof f.activation&&"relu"===f.activation&&(f.bias_pref=.1));a.push(f);"undefined"!==typeof f.activation&&("relu"===f.activation?a.push({type:"relu"}):"sigmoid"===f.activation?a.push({type:"sigmoid"}):"tanh"===f.activation?a.push({type:"tanh"}):"maxout"===f.activation?a.push({type:"maxout",group_size:"undefined"!==f.group_size?f.group_size:2}):console.log("ERROR unsupported activation "+f.activation));"undefined"!==typeof f.drop_prob&&"dropout"!==
f.type&&a.push({type:"dropout",drop_prob:f.drop_prob})}c=a;this.layers=[];for(a=0;a<c.length;a++)switch(b=c[a],0<a&&(f=this.layers[a-1],b.in_sx=f.out_sx,b.in_sy=f.out_sy,b.in_depth=f.out_depth),b.type){case "fc":this.layers.push(new e.FullyConnLayer(b));break;case "lrn":this.layers.push(new e.LocalResponseNormalizationLayer(b));break;case "dropout":this.layers.push(new e.DropoutLayer(b));break;case "input":this.layers.push(new e.InputLayer(b));break;case "softmax":this.layers.push(new e.SoftmaxLayer(b));
break;case "regression":this.layers.push(new e.RegressionLayer(b));break;case "conv":this.layers.push(new e.ConvLayer(b));break;case "pool":this.layers.push(new e.PoolLayer(b));break;case "relu":this.layers.push(new e.ReluLayer(b));break;case "sigmoid":this.layers.push(new e.SigmoidLayer(b));break;case "tanh":this.layers.push(new e.TanhLayer(b));break;case "maxout":this.layers.push(new e.MaxoutLayer(b));break;case "svm":this.layers.push(new e.SVMLayer(b));break;default:console.log("ERROR: UNRECOGNIZED LAYER TYPE: "+
b.type)}},forward:function(c,a){"undefined"===typeof a&&(a=!1);c=this.layers[0].forward(c,a);for(var b=1;b<this.layers.length;b++)c=this.layers[b].forward(c,a);return c},getCostLoss:function(b,a){this.forward(b,!1);return this.layers[this.layers.length-1].backward(a)},backward:function(b){var a=this.layers.length;b=this.layers[a-1].backward(b);for(a-=2;0<=a;a--)this.layers[a].backward();return b},getParamsAndGrads:function(){for(var b=[],a=0;a<this.layers.length;a++)for(var d=this.layers[a].getParamsAndGrads(),
f=0;f<d.length;f++)b.push(d[f]);return b},getPrediction:function(){var b=this.layers[this.layers.length-1];h("softmax"===b.layer_type,"getPrediction function assumes softmax as last layer of the net!");for(var b=b.out_act.w,a=b[0],d=0,f=1;f<b.length;f++)b[f]>a&&(a=b[f],d=f);return d},toJSON:function(){for(var b={layers:[]},a=0;a<this.layers.length;a++)b.layers.push(this.layers[a].toJSON());return b},fromJSON:function(b){this.layers=[];for(var a=0;a<b.layers.length;a++){var c=b.layers[a],f=c.layer_type,
n;"input"===f&&(n=new e.InputLayer);"relu"===f&&(n=new e.ReluLayer);"sigmoid"===f&&(n=new e.SigmoidLayer);"tanh"===f&&(n=new e.TanhLayer);"dropout"===f&&(n=new e.DropoutLayer);"conv"===f&&(n=new e.ConvLayer);"pool"===f&&(n=new e.PoolLayer);"lrn"===f&&(n=new e.LocalResponseNormalizationLayer);"softmax"===f&&(n=new e.SoftmaxLayer);"regression"===f&&(n=new e.RegressionLayer);"fc"===f&&(n=new e.FullyConnLayer);"maxout"===f&&(n=new e.MaxoutLayer);"svm"===f&&(n=new e.SVMLayer);n.fromJSON(c);this.layers.push(n)}}};
e.Net=b})(convnetjs);
(function(e){var h=function(b,c){this.net=b;c=c||{};this.learning_rate="undefined"!==typeof c.learning_rate?c.learning_rate:.01;this.l1_decay="undefined"!==typeof c.l1_decay?c.l1_decay:0;this.l2_decay="undefined"!==typeof c.l2_decay?c.l2_decay:0;this.batch_size="undefined"!==typeof c.batch_size?c.batch_size:1;this.method="undefined"!==typeof c.method?c.method:"sgd";this.momentum="undefined"!==typeof c.momentum?c.momentum:.9;this.ro="undefined"!==typeof c.ro?c.ro:.95;this.eps="undefined"!==typeof c.eps?
c.eps:1e-8;this.beta1="undefined"!==typeof c.beta1?c.beta1:.9;this.beta2="undefined"!==typeof c.beta2?c.beta2:.999;this.k=0;this.gsum=[];this.xsum=[];this.regression="regression"===this.net.layers[this.net.layers.length-1].layer_type?!0:!1};h.prototype={train:function(b,c){var a=(new Date).getTime();this.net.forward(b,!0);var d=(new Date).getTime();b=d-a;var a=(new Date).getTime(),f=this.net.backward(c),n=0,l=0,d=(new Date).getTime(),a=d-a;this.regression&&c.constructor!==Array&&console.log("Warning: a regression net requires an array as training output vector.");
this.k++;if(0===this.k%this.batch_size){c=this.net.getParamsAndGrads();if(0===this.gsum.length&&("sgd"!==this.method||0<this.momentum))for(d=0;d<c.length;d++)this.gsum.push(e.zeros(c[d].params.length)),"adam"===this.method||"adadelta"===this.method?this.xsum.push(e.zeros(c[d].params.length)):this.xsum.push([]);for(d=0;d<c.length;d++)for(var g=c[d],k=g.params,h=g.grads,v=this.l2_decay*("undefined"!==typeof g.l2_decay_mul?g.l2_decay_mul:1),g=this.l1_decay*("undefined"!==typeof g.l1_decay_mul?g.l1_decay_mul:
1),t=k.length,m=0;m<t;m++){var n=n+v*k[m]*k[m]/2,l=l+g*Math.abs(k[m]),q=(v*k[m]+g*(0<k[m]?1:-1)+h[m])/this.batch_size,p=this.gsum[d],w=this.xsum[d];if("adam"===this.method){p[m]=p[m]*this.beta1+(1-this.beta1)*q;w[m]=w[m]*this.beta2+(1-this.beta2)*q*q;var r=-this.learning_rate*p[m]*(1-Math.pow(this.beta1,this.k))/(Math.sqrt(w[m]*(1-Math.pow(this.beta2,this.k)))+this.eps);k[m]+=r}else"adagrad"===this.method?(p[m]+=q*q,r=-this.learning_rate/Math.sqrt(p[m]+this.eps)*q,k[m]+=r):"windowgrad"===this.method?
(p[m]=this.ro*p[m]+(1-this.ro)*q*q,r=-this.learning_rate/Math.sqrt(p[m]+this.eps)*q,k[m]+=r):"adadelta"===this.method?(p[m]=this.ro*p[m]+(1-this.ro)*q*q,r=-Math.sqrt((w[m]+this.eps)/(p[m]+this.eps))*q,w[m]=this.ro*w[m]+(1-this.ro)*r*r,k[m]+=r):"nesterov"===this.method?(r=p[m],p[m]=p[m]*this.momentum+this.learning_rate*q,r=this.momentum*r-(1+this.momentum)*p[m],k[m]+=r):0<this.momentum?(r=this.momentum*p[m]-this.learning_rate*q,p[m]=r,k[m]+=r):k[m]+=-this.learning_rate*q;h[m]=0}}return{fwd_time:b,
bwd_time:a,l2_decay_loss:n,l1_decay_loss:l,cost_loss:f,softmax_loss:f,loss:f+l+n}}};e.Trainer=h;e.SGDTrainer=h})(convnetjs);
(function(e){var h=!1,b=0,c=function(){if(h)return h=!1,b;var a=2*Math.random()-1,d=2*Math.random()-1,e=a*a+d*d;if(0==e||1<e)return c();e=Math.sqrt(-2*Math.log(e)/e);b=d*e;h=!0;return a*e},a=function(a,b){return Math.random()*(b-a)+a},d=function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return!0;return!1};e.randf=a;e.randi=function(a,b){return Math.floor(Math.random()*(b-a)+a)};e.randn=function(a,b){return a+c()*b};e.zeros=function(a){if("undefined"===typeof a||isNaN(a))return[];if("undefined"===
typeof ArrayBuffer){for(var b=Array(a),c=0;c<a;c++)b[c]=0;return b}return new Float64Array(a)};e.maxmin=function(a){if(0===a.length)return{};for(var b=a[0],c=a[0],d=0,f=0,e=a.length,h=1;h<e;h++)a[h]>b&&(b=a[h],d=h),a[h]<c&&(c=a[h],f=h);return{maxi:d,maxv:b,mini:f,minv:c,dv:b-c}};e.randperm=function(a){var b=a,c,d=[];for(c=0;c<a;c++)d[c]=c;for(;b--;)a=Math.floor(Math.random()*(b+1)),c=d[b],d[b]=d[a],d[a]=c;return d};e.weightedSample=function(b,c){for(var d=a(0,1),f=0,e=0,n=b.length;e<n;e++)if(f+=c[e],
d<f)return b[e]};e.arrUnique=function(a){for(var b=[],c=0,f=a.length;c<f;c++)d(b,a[c])||b.push(a[c]);return b};e.arrContains=d;e.getopt=function(a,b,c){if("string"===typeof b)return"undefined"!==typeof a[b]?a[b]:c;for(var d=0;d<b.length;d++){var f=b[d];"undefined"!==typeof a[f]&&(c=a[f])}return c};e.assert=function(a,b){if(!a){b=b||"Assertion failed";if("undefined"!==typeof Error)throw Error(b);throw b;}}})(convnetjs);
(function(e){var h=function(b,c,a,d){if("[object Array]"===Object.prototype.toString.call(b))for(this.sy=this.sx=1,this.depth=b.length,this.w=e.zeros(this.depth),this.dw=e.zeros(this.depth),c=0;c<this.depth;c++)this.w[c]=b[c];else{this.sx=b;this.sy=c;this.depth=a;var f=b*c*a;this.w=e.zeros(f);this.dw=e.zeros(f);if("undefined"===typeof d)for(b=Math.sqrt(1/(b*c*a)),c=0;c<f;c++)this.w[c]=e.randn(0,b);else for(c=0;c<f;c++)this.w[c]=d}};h.prototype={get:function(b,c,a){return this.w[(this.sx*c+b)*this.depth+
a]},set:function(b,c,a,d){this.w[(this.sx*c+b)*this.depth+a]=d},add:function(b,c,a,d){this.w[(this.sx*c+b)*this.depth+a]+=d},get_grad:function(b,c,a){return this.dw[(this.sx*c+b)*this.depth+a]},set_grad:function(b,c,a,d){this.dw[(this.sx*c+b)*this.depth+a]=d},add_grad:function(b,c,a,d){this.dw[(this.sx*c+b)*this.depth+a]+=d},cloneAndZero:function(){return new h(this.sx,this.sy,this.depth,0)},clone:function(){for(var b=new h(this.sx,this.sy,this.depth,0),c=this.w.length,a=0;a<c;a++)b.w[a]=this.w[a];
return b},addFrom:function(b){for(var c=0;c<this.w.length;c++)this.w[c]+=b.w[c]},addFromScaled:function(b,c){for(var a=0;a<this.w.length;a++)this.w[a]+=c*b.w[a]},setConst:function(b){for(var c=0;c<this.w.length;c++)this.w[c]=b},toJSON:function(){var b={};b.sx=this.sx;b.sy=this.sy;b.depth=this.depth;b.w=this.w;return b},fromJSON:function(b){this.sx=b.sx;this.sy=b.sy;this.depth=b.depth;var c=this.sx*this.sy*this.depth;this.w=e.zeros(c);this.dw=e.zeros(c);for(var a=0;a<c;a++)this.w[a]=b.w[a]}};e.Vol=
h})(convnetjs);
(function(e){var h=e.Vol;e.augment=function(b,c,a,d,f){"undefined"===typeof f&&(f=!1);"undefined"===typeof a&&(a=e.randi(0,b.sx-c));"undefined"===typeof d&&(d=e.randi(0,b.sy-c));var n;if(c!==b.sx||0!==a||0!==d){n=new h(c,c,b.depth,0);for(var l=0;l<c;l++)for(var g=0;g<c;g++)if(!(0>l+a||l+a>=b.sx||0>g+d||g+d>=b.sy))for(var k=0;k<b.depth;k++)n.set(l,g,k,b.get(l+a,g+d,k))}else n=b;if(f){b=n.cloneAndZero();for(l=0;l<n.sx;l++)for(g=0;g<n.sy;g++)for(k=0;k<n.depth;k++)b.set(l,g,k,n.get(n.sx-l-1,g,k));n=b}return n};
e.img_to_vol=function(b,c){"undefined"===typeof c&&(c=!1);var a=document.createElement("canvas");a.width=b.width;a.height=b.height;var d=a.getContext("2d");try{d.drawImage(b,0,0)}catch(l){if("NS_ERROR_NOT_AVAILABLE"===l.name)return!1;throw l;}try{var f=d.getImageData(0,0,a.width,a.height)}catch(l){if("IndexSizeError"===l.name)return!1;throw l;}f=f.data;a=b.width;b=b.height;for(var e=[],d=0;d<f.length;d++)e.push(f[d]/255-.5);f=new h(a,b,4,0);f.w=e;if(c){c=new h(a,b,1,0);for(d=0;d<a;d++)for(e=0;e<b;e++)c.set(d,
e,0,f.get(d,e,0));f=c}return f}})(convnetjs);